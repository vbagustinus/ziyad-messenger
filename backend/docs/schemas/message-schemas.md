# Message Schemas

## Core Message (Wire and Storage)

Aligns with `protocol.Message` and DB table `messages`.

| Field | Type | Description |
|-------|------|-------------|
| **id** | string (UUID) | Unique message ID |
| **channel_id** | string | Target channel |
| **sender_id** | string | User/account ID |
| **timestamp** | int64 | Unix milliseconds |
| **type** | int (MessageType) | 0 Unknown, 1 Text, 2 Image, 3 File, 4 System, 5 Voice |
| **content** | bytes (BLOB) | E2EE payload (opaque to server) |
| **nonce** | bytes | Used for AES-GCM / verification |
| **signature** | bytes | Sender signature over (channel_id, timestamp, content_hash) |

## MessageType Enum

| Value | Name | Description |
|-------|------|-------------|
| 0 | Unknown | Fallback |
| 1 | Text | Plain text (still E2EE in content) |
| 2 | Image | Image attachment reference or inline |
| 3 | File | File attachment reference (file_id) |
| 4 | System | System message (e.g. “user joined”) |
| 5 | Voice | Voice message reference |

## Send Message Request (Client → Server)

Aligns with `protocol.SendMessageRequest`.

| Field | Type | Description |
|-------|------|-------------|
| channel_id | string | Required |
| content | bytes (base64 in JSON) | Encrypted payload |
| nonce | bytes (base64) | |
| signature | bytes (base64) | |
| type | int | MessageType |

## Send Message Response

| Field | Type | Description |
|-------|------|-------------|
| message_id | string | Assigned ID |
| success | bool | |
| error | string | If success false |

## System and Broadcast Messages

- **type = System**: Generated by server or authorized service; content may be plaintext or signed payload; used for joins/leaves, alerts, announcements.
- **Broadcast / emergency**: Same message shape; routing scope is “all channels” or “all users”; QoS can be higher (guaranteed delivery, override DND).

## Topic-Based Routing

- **Topic** = channel_id (or reserved names for broadcast).
- Messaging Router routes by channel_id; subscribers receive only messages for channels they are subscribed to.
- **QoS**: At-least-once delivery with persistence; optional ack from client for “guaranteed” level.

## Offline Sync

- Client requests messages for channel since `last_timestamp` or `last_message_id`; server returns ordered list from DB.
- Message schema unchanged; client decrypts and merges into local view.
